<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teachers CRUD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="d-flex justify-content-between mb-3">
        <h3>Teachers</h3>
        <button class="btn btn-primary" onclick="openAddModal()">Add Teacher</button>
    </div>

    <table class="table table-bordered table-hover bg-white">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Surname</th>
            <th>Age</th>
            <th>Salary</th>
            <th>University</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="teachersTable"></tbody>
    </table>
</div>

<!-- ===== Teacher Students Modal ===== -->
<div class="modal fade" id="teacherStudentsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Teacher's Students</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-bordered">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Surname</th>
                        <th>Age</th>
                        <th>Scholarship</th>
                        <th>University</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <button class="btn btn-sm btn-success mb-2"
                            onclick="addStudentToTeacher(prompt('Enter Student ID to add:'))">Add Student</button>
                    <tbody id="teacherStudentsTable"></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- ===== Add / Edit Teacher Modal ===== -->
<div class="modal fade" id="teacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Teacher</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="teacherId">
                <div class="mb-2">
                    <label>Name</label>
                    <input id="name" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Surname</label>
                    <input id="surname" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Age</label>
                    <input id="age" type="number" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Salary</label>
                    <input id="salary" type="number" step="0.01" class="form-control">
                </div>
                <div class="mb-2">
                    <label>University ID</label>
                    <input id="university" type="number" class="form-control">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success" onclick="saveTeacher()">Save</button>
            </div>

        </div>
    </div>
</div>

<script>
    const TEACHER_API = "http://localhost:8080/api/teachers";
    const STUDENT_API = "http://localhost:8080/api/students";

    const teacherModal = new bootstrap.Modal(document.getElementById('teacherModal'));
    const teacherStudentsModal = new bootstrap.Modal(document.getElementById('teacherStudentsModal'));

    let currentTeacherId = null;

    loadTeachers();

    // ===== Load Teachers =====
    function loadTeachers() {
        fetch(TEACHER_API)
            .then(res => res.json())
            .then(response => {
                const table = document.getElementById("teachersTable");
                table.innerHTML = "";

                response.data.forEach(teacher => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${teacher.id}</td>
                        <td>${teacher.name}</td>
                        <td>${teacher.surname}</td>
                        <td>${teacher.age}</td>
                        <td>${teacher.salary}</td>
                        <td>${teacher.university ? teacher.university.name : ""}</td>
                        <td>
                            <button class="btn btn-sm btn-primary"
                                onclick='editTeacher(${JSON.stringify(teacher)})'>Edit</button>
                            <button class="btn btn-sm btn-danger"
                                onclick="deleteTeacher(${teacher.id})">Delete</button>
                            <button class="btn btn-sm btn-secondary"
                                onclick="getTeacherStudents(${teacher.id})">Students</button>
                        </td>
                    `;
                    table.appendChild(row);
                });
            });
    }

    // ===== Add / Edit Teacher =====
    function openAddModal() {
        document.getElementById("modalTitle").innerText = "Add Teacher";
        document.getElementById("teacherId").value = "";
        document.querySelectorAll("#teacherModal input").forEach(i => i.value = "");
        teacherModal.show();
    }

    function editTeacher(teacher) {
        document.getElementById("modalTitle").innerText = "Edit Teacher";
        document.getElementById("teacherId").value = teacher.id;
        document.getElementById("name").value = teacher.name || "";
        document.getElementById("surname").value = teacher.surname || "";
        document.getElementById("age").value = teacher.age || "";
        document.getElementById("salary").value = teacher.salary || "";

        // BURADA YALNIZ ID
        document.getElementById("university").value =
            teacher.university?.id || "";

        teacherModal.show();
    }


    function saveTeacher() {
        const id = document.getElementById("teacherId").value;

        const nameEl = document.getElementById("name");
        const surnameEl = document.getElementById("surname");
        const ageEl = document.getElementById("age");
        const salaryEl = document.getElementById("salary");
        const universityEl = document.getElementById("university");

        const body = {
            name: nameEl.value.trim(),
            surname: surnameEl.value.trim(),
            age: ageEl.value ? Number(ageEl.value) : null,
            salary: salaryEl.value ? Number(salaryEl.value) : null,
            university: universityEl.value
                ? { id: Number(universityEl.value) }
                : null
        };

        fetch(id ? `${TEACHER_API}/${id}` : TEACHER_API, {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(() => {
            teacherModal.hide();
            loadTeachers();
        });
    }

    function deleteTeacher(id) {
        if (!confirm("Delete teacher?")) return;
        fetch(`${TEACHER_API}/${id}`, { method: "DELETE" })
            .then(() => loadTeachers());
    }

    // ===== Teacher Students =====
    function getTeacherStudents(teacherId) {
        currentTeacherId = teacherId;

        fetch(`${TEACHER_API}/${teacherId}/students`)
            .then(res => res.json())
            .then(response => {
                const table = document.getElementById("teacherStudentsTable");
                table.innerHTML = "";

                response.data.forEach(student => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${student.surname}</td>
                        <td>${student.age}</td>
                        <td>${student.scholarship}</td>
                        <td>${student.university?.name || ""}</td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                onclick="removeStudentFromTeacher(${student.id})">Remove</button>
                        </td>
                    `;
                    table.appendChild(row);
                });

                teacherStudentsModal.show();
            });
    }

    // ===== Remove Student from Teacher =====
    function removeStudentFromTeacher(studentId) {
        if (!confirm("Remove student from teacher?")) return;

        fetch(`${TEACHER_API}/${currentTeacherId}/students/${studentId}`, {
            method: "DELETE"
        }).then(() => getTeacherStudents(currentTeacherId));
    }

    function addStudentToTeacher(studentId) {
        fetch(`${TEACHER_API}/${currentTeacherId}/students/${studentId}`, {
            method: "POST"
        }).then(() => getTeacherStudents(currentTeacherId));
    }
</script>

</body>
</html>
